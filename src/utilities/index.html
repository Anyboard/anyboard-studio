<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no
 initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

  <title>AnyboardGameDemo</title>

  <style>
    @import 'ui/css/evothings-app.css';
  </style>

  <!-- cordova.js based -->
  <script src="cordova.js"></script>

  <!-- AnyboardJS libraries -->
  <script src="dist/anyboard.js"></script>

  <!-- Bluetooth driver and dependencies-->
  <script src="libs/evothings/evothings.js"></script>
  <script src="libs/evothings/easyble/easyble.js"></script>
  <script src="drivers/discovery.evothings.bluetooth.js"></script>
  <script src="drivers/bean.evothings.bluetooth.js"></script>
  <script src="drivers/rfduino.evothings.bluetooth.js"></script>

  <!-- We've used jquery for quick development -->
  <script src="libs/jquery-1.11.3.min.js"></script>

  <script>
    $(document).ready(function(){
      $("#summary").show();
      $("#main").hide();
    });
  </script>

  <script>
    var app;
    app = {
      currentColor: "some value",
      devices: {},
      currentTile: "white",

      //REPLACEMEOKAY//

      // Discover bluetooth tokens in proximity
      discover: function () {
        var self = this;
        AnyBoard.TokenManager.scan(
          // success function to be executed upon _each_ token that is discovered
          function (token) {
            self.addDiscovered(token);
          },
          // function to be executed upon failure
          function (errorCode) {
            console.log(errorCode)
          }
        );
      },

      // Function to be executed upon having discovered a token
      addDiscovered: function (token) {
        if (!this.devices[token.name]) {
          this.devices[token.name] = token;

          // Add button for token to body
          //document.body.innerHTML += '<button type="button" id="' + token.name + '" onclick="app.connect(' + "'" + token.name + "'" + ')" class="grey">' + token.name + ' </button><br />';
          $("#tokens").append('<button type="button" id="' + token.name + '" onclick="app.connect(' + "'" + token.name + "'" + ')" class="grey">' + token.name + ' </button><br />');

          // Add listener to be executed if the token connects
          token.on('connect', function () {
            document.getElementById(token.name).className = 'green';
            $('#next').show()
            //$("#token_feedback").append('<button type="button" onclick="app.verifyColor(' + "'" + token.name + "'" + ')"class="indicator3"> Verify color</button><br />');
          });

          // Add listener to be executed if the token disconnects
          token.on('disconnect', function () {
            document.getElementById(token.name).className = 'red';
          });
        }

      },

      // Attempts to connect to token.
      connect: function (tokenName) {
        var token = this.devices[tokenName];

        // If already connecting, stop
        if (document.getElementById(tokenName).className == 'blue')
          return;

        // If already connected, attempt to send green led command
        if (document.getElementById(tokenName).className == 'green') {
          this.sendVibrationCmd(token);
          return;
        }

        // Signal that we're attempting to connect
        document.getElementById(tokenName).className = 'blue';
        // Send connect command.
        token.connect();
      },

      // Feedback commands
      sendVibrationCmd: function (token) {

        var completedFunction = function (data) {
          hyper.log("We happily send the VIBRATE command");
          hyper.log(data)
        };

        var errorCallback = function (errorMsg) {
          hyper.log("Failed to send the VIBRATE command");
          hyper.log(errorMsg);
        };

        if(app.tokenVal.hasOwnProperty(token.id)) {
          if (!(app.tokenVal[token.id].includes('vibrate'))) {
            token.vibrate([100],
              completedFunction,  // function to be executed when token signals
              errorCallback  // function to be executed in case of failure to send command to token
            );
          }
        } else {
          token.vibrate([100],
            completedFunction,  // function to be executed when token signals
            errorCallback  // function to be executed in case of failure to send command to token
          );
        }
      },

      sendVibrationPatternCmd: function (token, pattern) {

        var completedFunction = function (data) {
          hyper.log("We happily send the VIBRATEPATTERN command");
          hyper.log(data)
        };

        var errorCallback = function (errorMsg) {
          hyper.log("Failed to send the VIBRATEPATTERN command");
          hyper.log(errorMsg);
        };

        if(app.tokenVal.hasOwnProperty(token.id)) {
          if (!(app.tokenVal[token.id].includes('vibratePattern'))) {
            token.vibratePattern(pattern,
              completedFunction,  // function to be executed when token signals
              errorCallback  // function to be executed in case of failure to send command to token
            );
          }
        } else {
          token.vibratePattern(pattern,
            completedFunction,  // function to be executed when token signals
            errorCallback  // function to be executed in case of failure to send command to token
          );
        }
      },

      sendLedOnCmd: function (token, ledArray) {

        var completedFunction = function (data) {
          hyper.log("We happily send the LEDON command");
          hyper.log(data)
        };

        var errorCallback = function (errorMsg) {
          hyper.log("Failed to send the LEDON command");
          hyper.log(errorMsg);
        };

        if(app.tokenVal.hasOwnProperty(token.id)) {
          if (!(app.tokenVal[token.id].includes('ledon'))) {
            token.ledOn(ledArray,
              completedFunction,  // function to be executed when token signals
              errorCallback  // function to be executed in case of failure to send command to token
            );
          }
        } else {
          token.ledOn(ledArray,
            completedFunction,  // function to be executed when token signals
            errorCallback  // function to be executed in case of failure to send command to token
          );
        }
      },

      sendLedBlinkCmd: function (token, time, frequency) {

        var completedFunction = function (data) {
          hyper.log("We happily send the LEDBLINK command");
          hyper.log(data)
        };

        var errorCallback = function (errorMsg) {
          hyper.log("Failed to send the LEDBLINK command");
          hyper.log(errorMsg);
        };

        if(app.tokenVal.hasOwnProperty(token.id)) {
          if (!(app.tokenVal[token.id].includes('ledblink'))) {
            token.ledBlink(time, frequency,
              completedFunction,  // function to be executed when token signals
              errorCallback  // function to be executed in case of failure to send command to token
            );
          }
        } else {
          token.ledBlink(time, frequency,
            completedFunction,  // function to be executed when token signals
            errorCallback  // function to be executed in case of failure to send command to token
          );
        }
      },

      sendMatrixCmd: function (token, grid, time) {

        var completedFunction = function (data) {
          hyper.log("We happily send the MATRIX command");
          hyper.log(data)
        };

        var errorCallback = function (errorMsg) {
          hyper.log("Failed to send the MATRIX command");
          hyper.log(errorMsg);
        };

        if(app.tokenVal.hasOwnProperty(token.id)) {
          if (!(app.tokenVal[token.id].includes('matrix'))) {
            token.matrix(grid, time,
              completedFunction,  // function to be executed when token signals
              errorCallback  // function to be executed in case of failure to send command to token
            );
          }
        } else {
          token.matrix(grid, time,
            completedFunction,  // function to be executed when token signals
            errorCallback  // function to be executed in case of failure to send command to token
          );
        }
      },

      sendMatrixTextCmd: function (token, text, time) {

        var completedFunction = function (data) {
          hyper.log("We happily send the MATRIXTEXT command");
          hyper.log(data)
        };

        var errorCallback = function (errorMsg) {
          hyper.log("Failed to send the MATRIXTEXT command");
          hyper.log(errorMsg);
        };

        if(app.tokenVal.hasOwnProperty(token.id)) {
          if (!(app.tokenVal[token.id].includes('matrixText'))) {
            token.matrixText(text, time,
              completedFunction,  // function to be executed when token signals
              errorCallback  // function to be executed in case of failure to send command to token
            );
          }
        } else {
          token.matrixText(text, time,
            completedFunction,  // function to be executed when token signals
            errorCallback  // function to be executed in case of failure to send command to token
          );
        }
      },

      sendCountCmd: function (token, num1, num2, time) {

        var completedFunction = function (data) {
          hyper.log("We happily send the COUNT command");
          hyper.log(data)
        };

        var errorCallback = function (errorMsg) {
          hyper.log("Failed to send the COUNT command");
          hyper.log(errorMsg);
        };

        if(app.tokenVal.hasOwnProperty(token.id)) {
          if (!(app.tokenVal[token.id].includes('count'))) {
            token.count(num1, num2, time,
              completedFunction,  // function to be executed when token signals
              errorCallback  // function to be executed in case of failure to send command to token
            );
          }
        } else {
          token.count(num1, num2, time,
            completedFunction,  // function to be executed when token signals
            errorCallback  // function to be executed in case of failure to send command to token
          );
        }
      },

      next_panel: function () {
        $("#summary").hide();
        app.initiate();
      },

      getSector: function (token) {
        for (var key in this.devices){
          if (this.devices[key] == token){
            return this.devices[key].sector;
          }
        }
        return false;
      },

      getRandomToken: function () {
        var obj_keys = Object.keys(app.devices);
        var ran_key = obj_keys[Math.floor(Math.random() *obj_keys.length)];
        return app.devices[ran_key];
      },

      getRandomSector: function () {
        return app.sectorVals[Math.floor(Math.random() * app.sectorVals.length)]
      },

      showTextPrompt: function (value) {
        $('#promptField').html(value)
        $('#textprompt').show()
      },

      mathRandomInt: function (a, b) {
        if (a > b) {
          // Swap a and b to ensure a is smaller.
          var c = a;
          a = b;
          b = c;
        }
        return Math.floor(Math.random() * (b - a + 1) + a);
      },

      getTextPrompt: function () {
        return $('#promptField').value
        $('#textprompt').hide()
      }

    };
  </script>
</head>

<body ontouchstart="">
<div id="summary">
  <button type="button" class="black" onclick="app.discover()">
    Discover Bluetooth devices
  </button>
  <div id="tokens"></div>
  <button type="button" onclick="app.next_panel()" class="black" id="next" style="display: none;"> Next </button>
</div>
<div id="connected"></div>
<div id="token_constraint">
  <h1 id="title">Game Title</h1>
  <h1>Messages</h1>

  <div id="messagediv">
    <p id="message1"></p>
    <p id="message2"></p>
    <p id="message3"></p>
  </div>

  <div id="numberdiv">
    <p id="number1"></p>
    <p id="number2"></p>
    <p id="number3"></p>
  </div>
</div>
</body>

<style>
  #messagediv {
    word-wrap: break-word;
  }
</style>

</html>
