<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no
		initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

  <title>AnyboardGameDemo</title>

  <style>
    @import 'ui/css/evothings-app.css';
  </style>

  <!-- cordova.js based -->
  <script src="cordova.js"></script>

  <!-- AnyboardJS libraries -->
  <script src="dist/anyboard.js"></script>

  <!-- Bluetooth driver and dependencies-->
  <script src="libs/evothings/evothings.js"></script>
  <script src="libs/evothings/easyble/easyble.js"></script>
  <script src="drivers/discovery.evothings.bluetooth.js"></script>
  <script src="drivers/bean.evothings.bluetooth.js"></script>
  <script src="drivers/rfduino.evothings.bluetooth.js"></script>

  <!-- We've used jquery for quick development -->
  <script src="libs/jquery-1.11.3.min.js"></script>

  <script>
    $(document).ready(function(){
      $("#summary").show();
      $("#main").hide();
      app.initiate();
    });
  </script>

  <script>
    var app;
    app = {
      score: 0,
      currentColor: "some value",
      devices: {},
      tiles: {
        1: "white",
        2: "white"
      },

      locations: {
        1: "red", // 12228
        2: "black", // 5737
        3: "yellow", // 18330
        4: "green", // 4560
        5: "purple", // 8550
        6: "blue", // 6306
      },

      initiate: function () {
        $("#scorediv").html("Current score is 0");
        var handleTokenTap = function (token) {
          AnyBoard.Logger.log(" TAP Detect ");
          $("#tap").css("background-color", "red");
          setTimeout(function () {
            $("#tap").css("background-color", "#99C2FF");
          }, 300);
        };
        var handleTokenDoubleTap = function (token) {
          AnyBoard.Logger.log(" DOUBLE TAP Detect ");
          $("#double_tap").css("background-color", "blue");
          setTimeout(function () {
            $("#double_tap").css("background-color", "#99C2FF");
          }, 300);
        };
        var handleTokenShake = function (token) {
          AnyBoard.Logger.log(" SHAKE Detect ");
          $("#shake").css("background-color", "blue");
          setTimeout(function () {
            $("#shake").css("background-color", "#99C2FF");
          }, 300);
        };
        var handleTokenTilt = function (token) {
          AnyBoard.Logger.log(" TILT Detect ");
          app.diceRoll();
          setTimeout(function () {
            $("#tilt").css("background-color", "#99C2FF");
          }, 550);
        };
        AnyBoard.TokenManager.onTokenEvent("TAP", handleTokenTap);
        AnyBoard.TokenManager.onTokenEvent("DOUBLE_TAP", handleTokenDoubleTap);
        AnyBoard.TokenManager.onTokenEvent("SHAKE", handleTokenShake);
        AnyBoard.TokenManager.onTokenEvent("TILT", handleTokenTilt);

        var handleTokenMove = function (token, constraint, options) {
          AnyBoard.Logger.log("Moved to tilee " + constraint);
          app.tiles[2] = app.locations[constraint];
          $('.current_tile').css("background-color", app.tiles[2]);
          app.verifyColor(token.name);
        };

        //TT Events not implmented
        var handleTokenTokenEvent = function (token) {
          AnyBoard.Logger.log("Token-Token event triggered.");
          $("#tokentoken").css("background-color", "blue");
          setTimeout(function () {
            $("#tokentoken").css("background-color", "#99C2FF");
          }, 550);
        };

        AnyBoard.TokenManager.onTokenConstraintEvent("MOVE_TO", handleTokenMove);
        AnyBoard.TokenManager.onTokenTokenEvent("TTEVENT", handleTokenTokenEvent);
        this.hardCodedInitialise();
      },

      // Discover bluetooth tokens in proximity
      discover: function () {
        var self = this;
        AnyBoard.TokenManager.scan(
          // success function to be executed upon _each_ token that is discovered
          function (token) {
            self.addDiscovered(token);
          },
          // function to be executed upon failure
          function (errorCode) {
            console.log(errorCode)
          }
        );
      },

      // Function to be executed upon having discovered a token
      addDiscovered: function (token) {
        if (!this.devices[token.name]) {
          this.devices[token.name] = token;

          // Add button for token to body
          //document.body.innerHTML += '<button type="button" id="' + token.name + '" onclick="app.connect(' + "'" + token.name + "'" + ')" class="grey">' + token.name + ' </button><br />';
          $("#summary").append('<button type="button" id="' + token.name + '" onclick="app.connect(' + "'" + token.name + "'" + ')" class="grey">' + token.name + ' </button><br />');

          // Add listener to be executed if the token connects
          token.on('connect', function () {
            document.getElementById(token.name).className = 'green';
            $("#token_feedback").append('<button type="button" onclick="app.pickRandomColor()"class="indicator3"> Pick random color</button><br />');
            $("#token_feedback").append('<button type="button" onclick="app.verifyColor(' + "'" + token.name + "'" + ')"class="indicator3"> Verify color</button><br />');
          });

          // Add listener to be executed if the token disconnects
          token.on('disconnect', function () {
            document.getElementById(token.name).className = 'red';
          });
        }

      },

      // Attempts to connect to token.
      connect: function (tokenName) {
        var token = this.devices[tokenName];

        // If already connecting, stop
        if (document.getElementById(tokenName).className == 'blue')
          return;

        // If already connected, attempt to send green led command
        if (document.getElementById(tokenName).className == 'green') {
          this.sendVibrationCmd(token);
          return;
        }

        // Signal that we're attempting to connect
        document.getElementById(tokenName).className = 'blue';
        // Send connect command.
        token.connect(app.next_panel());

        // Add button for token to body
        //$("#summary").append('<button type="button" onclick="app.next_panel()" class="black"> Next </button>');

      },

      // Send green led command. Works on every token with a AnyBoard compatible driver and firmware.
      sendVibrationCmd: function (token) {

        // Function to be executed when LED is successfully turned on
        var completedFunction = function (data) {
          hyper.log("We happily send the VIBRATE command");
          hyper.log(data)
        };

        // Function to be executed upon failure of LED
        var errorCallback = function (errorMsg) {
          hyper.log("Failed to send the VIBRATE command");
          hyper.log(errorMsg);
        };

        // Turns on token led.
        token.vibrate([100], // Instead of "green" color, on could also use array, e.g. [0, 255, 0]
          completedFunction,  // function to be executed when token signals
          errorCallback  // function to be executed in case of failure to send command to token
        );
      },

      // Send green led command. Works on every token with a AnyBoard compatible driver and firmware.
      sendCountCmd: function (token) {
        token.vibrate(100);
        // Function to be executed when LED is successfully turned on
        var completedFunction = function (data) {
          hyper.log("We happily send the COUNT command");
          hyper.log(data)
        };
        // Function to be executed upon failure of LED
        var errorCallback = function (errorMsg) {
          hyper.log("Failed to send the COUNT command");
          hyper.log(errorMsg);
        };

        // Turns on token led.
        token.vibrate(token),
          token.count([100], // Instead of "green" color, on could also use array, e.g. [0, 255, 0]
            completedFunction,  // function to be executed when token signals
            errorCallback  // function to be executed in case of failure to send command to token
          );
      },

      sendDisplayXCmd: function (token) {

        // Function to be executed when LED is successfully turned on
        var completedFunction = function (data) {
          hyper.log("We happily send the DISPLAY_X command");
          hyper.log(data)
        };

        // Function to be executed upon failure of LED
        var errorCallback = function (errorMsg) {
          hyper.log("Failed to send the DISPLAY_X command");
          hyper.log(errorMsg);
        };

        // Turns on token led.
        token.displayX([0, 255, 0], // Instead of "green" color, on could also use array, e.g. [0, 255, 0]
          completedFunction,  // function to be executed when token signals
          errorCallback  // function to be executed in case of failure to send command to token
        );
      },

      next_panel: function () {
        $("#summary").hide();
      },

      vibrate: function (tokenName) {
        var token = this.devices[tokenName];
        this.sendVibrationCmd(token);
      },

      hardCodedInitialise: function () {
        this.pickRandomColor();
        app.tiles[2] = app.locations[1];
        $('.current_tile').css("background-color", app.tiles[2]);
      },

      pickRandomColor: function () {
        var currentColor = this.locations[Math.floor(Math.random() *6 + 1)]
        if (currentColor == this.currentColor) {
          this.pickRandomColor();
        }
        else {
          this.currentColor = currentColor;
          $('.wanted_tile').css("background-color", this.currentColor);
        }
      },

      verifyColor: function (tokenName) {
        var token = this.devices[tokenName];
        if (app.tiles[2] == this.currentColor) {
          this.sendVibrationCmd(token);
          this.updateScore();
          this.pickRandomColor();
        }
        else {
          this.downgradeScore();

        }
      },

      downgradeScore: function () {
        this.score-=1;
        var scoreString = "Wrong color! Current score is " + this.score.toString();
        $("#scorediv").html(scoreString);
      },

      updateScore: function () {
        this.score+=1;
        var scoreString = "Correct color! Current score is " + this.score.toString();
        $("#scorediv").html(scoreString);
      },

      count: function (tokenName) {
        var token = this.devices[tokenName];
        this.sendCountCmd(token);

      },

      displayX: function (tokenName) {
        var token = this.devices[tokenName];
        this.sendDisplayXCmd(token);
      },

      diceRoll: function (){
        document.getElementById("dice").innerHTML = "";
        document.getElementById("dice").appendChild(document.createTextNode(""+Math.floor(Math.random() * 6 + 1)));
      }
    };
  </script>

</head>

<body ontouchstart="">
<div id="summary">
  <h1>AnyboardGameDemo</h1>
  <button type="button" class="black" onclick="app.discover()">
    Discover Bluetooth devices
  </button>
</div>
<div id="token_feedback"></div>
<div id="token_constraint">
  <h1>Colors</h1>
  <div id="scorediv">
    <p id="score">Current score is 0</p>
  </div>

  <div id="messagediv">
    <p id="message"></p>
  </div>

  <div id="tileContainer">

    <div class="tile">
      <p>Current tile</p>
      <div id="color" class="current_tile"></div>
    </div>

    <div class="tile">
      <p>Wanted tile</p>
      <div id="color" class="wanted_tile"></div>
    </div>
  </div>
  <div id="doYouLikeToDAIS">
    <h1>LEGAL DICE ZONE</h1>
    <div id="dice">0</div>
  </div>
</div>
</body>

</html>
